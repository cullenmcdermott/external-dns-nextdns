# Flox Environment Manifest for external-dns-nextdns-webhook

version = 1

[install]
# Go toolchain
go.pkg-path = "go"
go.version = "=1.25"

# Go development tools
golangci-lint.pkg-path = "golangci-lint"
delve.pkg-path = "delve"
go-tools.pkg-path = "gotools"

# Kubernetes tools
kind.pkg-path = "kind"
kubectl.pkg-path = "kubectl"
helm.pkg-path = "kubernetes-helm"
ctlptl.pkg-path = "ctlptl"
tilt.pkg-path = "tilt"
kustomize.pkg-path = "kustomize"

# Container tools
docker.pkg-path = "docker"
docker-compose.pkg-path = "docker-compose"

# Task runner
just.pkg-path = "just"

# CI/CD tools
dagger.flake = "github:dagger/nix#dagger"
git-cliff.pkg-path = "git-cliff"

# Utilities
jq.pkg-path = "jq"
yq.pkg-path = "yq-go"
git.pkg-path = "git"
curl.pkg-path = "curl"
op.pkg-path = "_1password-cli"
gum.pkg-path = "gum"

[vars]
PROJECT_NAME = "external-dns-nextdns-webhook"
VERSION = "dev"
BINARY_NAME = "webhook"
GO111MODULE = "on"
CGO_ENABLED = "0"
LOG_LEVEL = "info"
DOCKER_IMAGE = "external-dns-nextdns-webhook"
KIND_CLUSTER_NAME = "kind-external-dns-dev"

[hook]
on-activate = '''
# Workaround for glibc TLS race condition in GitHub Actions
unset LD_AUDIT

setup_go_deps() {
  local deps_flag="$FLOX_ENV_CACHE/.go_deps_installed"
  if [ ! -f "$deps_flag" ] && [ -f "$FLOX_ENV_PROJECT/go.mod" ]; then
    go mod download && touch "$deps_flag"
  fi
}

setup_kubectl_context() {
  if kind get clusters 2>/dev/null | grep -q "^${KIND_CLUSTER_NAME}$"; then
    kubectl config use-context "${KIND_CLUSTER_NAME}" >/dev/null 2>&1
  fi
}

export GOENV="${FLOX_ENV_CACHE:-/tmp}/goenv"
export GOCACHE="${FLOX_ENV_CACHE:-/tmp}/go-build"
export GOMODCACHE="${FLOX_ENV_CACHE:-/tmp}/go/pkg/mod"
mkdir -p "$GOENV" "$GOCACHE" "$GOMODCACHE"

setup_go_deps
setup_kubectl_context
cd "$FLOX_ENV_PROJECT"
'''

[services.dev]
command = """
set -e
cd "$FLOX_ENV_PROJECT"

cleanup() {
  echo "Cleaning up development environment..."
  tilt down 2>/dev/null || true
  ctlptl delete cluster kind-external-dns-dev 2>/dev/null || true
}

trap cleanup EXIT INT TERM

export KUBECONFIG="$HOME/.kube/config"
ctlptl apply -f ctlptl-config.yaml
kubectl config use-context "${KIND_CLUSTER_NAME}"
kubectl wait --for=condition=Ready nodes --all --timeout=90s
tilt up --host 0.0.0.0 --port 10350
"""
